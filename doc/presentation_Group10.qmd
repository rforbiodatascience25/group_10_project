---
title: "Antibiotic Resistance"
subtitle: "Project Group 10"
author: "Edene Levine · Molly Hong-Minh · Pablo Vivero · Vinit Nilesh Vasa"
format: 
  revealjs:
    slide-number: c/t
    title-slide-attributes:
      data-background-color: "#003049"
      data-background-opacity: "1"
editor: visual
---

## Data & Aims {.small}

**Dataset Overview:**\
[A collection of bacterial isolates with associated patient demographics, clinical factors and antibiotic susceptibility results.]{style="font-size:75%;"}

::: {style="height:0.5em;"}
:::

::: fragment
**Aims:**\
[- Determine which clinical or individual variables significantly influence the number of resistances in an infection using linear models\
- Explore antibiotic resistance profiles across species using visualisation techniques such as heatmaps\
- Perform PCA to identify clustering based on resistance profiles]{style="font-size:75%;"}

<br>

[**Data:** https://www.kaggle.com/datasets/adilimadeddinehosni/multi-resistance-antibiotic-susceptibility/data]{style="font-size: 40%;"}
:::

## Data Processing & Description {.smaller}

Data Loading, Cleaning & Overview

::::::: columns
:::: {.column width="50%"}
### [Workflow]{style="font-size:0.6em"}

::: incremental
-   **`library(Rkaggle)`**: Load data directly from Kaggle
-   **Clean Data**: Remove NAs, duplicates & unnecessary columns
-   **Tidy Data**: Restructure data into tidy format
-   **Renaming**: Identify naming inconsistencies & rename accordingly
-   **Data Description**: `table1()` and `ggplot()`
:::
::::

:::: {.column width="50%"}
::: fragment
### Table 1 {style="font-size:1.0em"}

```{r results='asis'}
library(here)
library(table1)
library(htmltools)

# Load Data
mdr_data <- read.csv(here("data/cleaned_bacteria_data.csv"))

# Create table
t1 <- table1(
  ~ Age + Gender + Diabetes + Hypertension + Hospital_before +
    Infection_Freq +
    AMX.AMP + AMC + CZ + FOX + CTX.CRO + IPM + GEN + AN +
    Acide.nalidixique + ofx + CIP + C + Co.trimoxazole +
    Furanes + colistine
  | Species,
  data = mdr_data
)

# Bigger table, smaller text
div(
  style = "
    font-size: 0.45em;         /* make text smaller */
    transform: scale(1.2);     /* make table itself bigger */
    transform-origin: top left;
    height: 350px;             /* vertical scroll box */
    width: 100%;               
    overflow: auto; 
  ",
  t1
)

```
:::
::::
:::::::

## Data Processing & Description {.smaller}

Data Loading, Cleaning & Overview

::::: columns
::: {.column width="50%"}
### [Workflow]{style="font-size:0.6em"}

-   **`library(Rkaggle)`**: Load data directly from Kaggle
-   **Clean Data**: Remove NAs, duplicates & unnecessary columns
-   **Tidy Data**: Restructure data into tidy format
-   **Renaming**: Identify naming inconsistencies & rename accordingly
-   **Data Description**: `table1()` and `ggplot()`
:::

::: {.column width="50%"}
![](images/04_Age_Gender.png){style="\"width:100%"}
:::
:::::

## Data Processing & Description {.smaller}

Data Loading, Cleaning & Overview

::::: columns
::: {.column width="50%"}
### [Workflow]{style="font-size:0.6em"}

-   **`library(Rkaggle)`**: Load data directly from Kaggle
-   **Clean Data**: Remove NAs, duplicates & unnecessary columns
-   **Tidy Data**: Restructure data into tidy format
-   **Renaming**: Identify naming inconsistencies & rename accordingly
-   **Data Description**: `table1()` and `ggplot()`
:::

::: {.column width="50%"}
![](images/04_Species.png){style="\"width:100%"}
:::
:::::

## Data Augmentation {.smaller}

New data frame in long format, and creation and modification of variables for the downstream analyses.

:::::: columns
:::: {.column width="50%"}
### [Workflow]{style="font-size:0.6em"}

::: incremental
-   **`data.frame()`**: Creates a lookup table linking antibiotic codes with their full names and pharmacological classes
-   **`pivot_longer()` + `left_join()`**: Reshapes the dataset and merges antibiotic information
-   **MDR variable**: Converts R=1, I=0.5, S=0 across antibiotics and sums the values to obtain a resistance score
-   **Age-group variable**: Bins ages into 10-year categorical intervals
:::
::::

::: {.column width="50%"}
### [Code]{style="font-size:0.6em"}

``` r
#MDR variable
antibiotics_cols <- colnames(mdr_data)[c(8:ncol(mdr_data))]

#Apply the case_when function to mutate every antibiotic column and sum into MDR variable
#Count resistance is a function in 99_proj_func.R
mdr_wide <- mdr_data |>
  mutate(
    across(antibiotics_cols, 
           count_resistance)) |> 
  mutate(MDR = rowSums(across(antibiotics_cols))) |> 
  drop_na(Age, Gender, Species, Diabetes, Hypertension, Hospital_before, Infection_Freq, MDR)   #Drop all NA in the columns used to model
     
     ...

#Age-group variable
breaks <- seq(0, 90, 10)
labels <- paste0("[", head(breaks, -1), ",", tail(breaks, -1), "]")

mdr_wide <- mdr_wide |> 
  mutate(age_group = cut(
         x = Age,
         breaks = breaks,
             right = FALSE,
    include.lowest = TRUE,
    labels = labels))
```
:::
::::::

## Linear Model MDR {.smaller}

Analysis of how `age`, `gender`, `bacterial species`, `diabetes`, `hypertension`, `prior hospitalisation` and `infection frequency` influence the number of antibiotic resistances in a contracted infection using a linear model.

:::::: columns
:::: {.column width="50%"}
### [Workflow]{style="font-size:0.6em"}

::: incremental
-   **`lm()`**: Fits the linear model predicting MDR
-   **`broom::tidy()`**: Extracts coefficients, confidence intervals, and p-values
-   **`mutate()`**: Cleans variable names and adds significance flag
-   **`stringr::str_replace()`**: Standardises variable labels
:::
::::

::: {.column width="50%"}
### [Code]{style="font-size:0.6em"}

``` r
#Linear model
linear_model <- MDR_df |> 
  lm(formula = MDR ~ Age + Gender + Species + Diabetes + Hypertension + Hospital_before + Infection_Freq,
     data = _)
     
     ...

#Tidy format     
tidy_lm <- tidy(linear_model, 
     conf.int = TRUE,
     conf.level = 0.95) |> 
  mutate(term = str_replace(term, "Species", "")) |> 
  mutate(term = str_replace(term, "Yes", "")) |> 
  mutate(term = str_replace(term, "GenderM", "Gender_M")) |> 
  mutate(term = str_replace(term, "Freq1", "Freq_1")) |>
  mutate(term = str_replace(term, "Freq2", "Freq_2")) |>
  mutate(term = str_replace(term, "Freq3", "Freq_3")) |> 
  mutate(sig = factor(p.value < 0.05))
```
:::
::::::

## Linear Model MDR {.smaller}

::::: columns
::: {.column width="50%"}
#### Forest Plot

![](images/05_MDR_forest.png){style="\"width:100%"}
:::

::: {.column width="50%"}
#### Volcano Plot

![](images/05_MDR_volcano.png){style="\"width:100%"}
:::
:::::

[Only bacterial species significantly affect MDR]{style="font-size:0.7em; text-align:center; display:block;"}

## Linear Model Infection frequency

:::::: columns
:::: {.column width="40%"}
::: {style="max-width:100%; font-size:0.9rem; overflow:auto;"}
| Model 1         | Model 2           | Model 3    | Model 4      |
|-----------------|-------------------|------------|--------------|
| Patient details | Bacterial species | MDR        | Multivariate |
| p = 0.5394      | p = 0.03842       | p = 0.6002 | p = 0.08977  |
:::
::::

::: {.column width="60%"}
![](images/infect_plot1.png){style="\"width:100%"}
:::
::::::

## Bacterial Resistance Heatmap

![](images/heatmap_resistance.png){fig-align="center"}

[Shows resistance patterns across bacterial species using the long-format dataset: E. coli and K. pneumoniae show the highest resistance (red), most other species remain largely sensitive (blue), and several antibiotics stay effective across multiple species.]{style="font-size: 50%;"}

</p>

## PCA {.smaller}

Identify shared patterns of antibiotic resistance across bacterial species.

:::::: columns
:::: {.column width="50%"}
### [Workflow]{style="font-size:0.6em"}

::: incremental
-   **`select()`**: Extracts only the antibiotic-resistance columns used for PCA
-   **`prcomp()`**: Performs the PCA with variable scaling
-   **`augment()`**: Attaches PCA scores (PC1, PC2…) back to the original dataset
-   **`count()`** — Determines number of isolates per species
-   **`slice_sample()`**: Downsamples species to equal sizes for balanced PCA
:::
::::

::: {.column width="50%"}
### [Code]{style="font-size:0.6em"}

``` r
#Variable selection and PCA
antibiotics_cols <- colnames(MDR_df)[c(8:(ncol(MDR_df)-1))]

pca_fit <- MDR_df |>
  select(all_of(antibiotics_cols)) |> 
  prcomp(scale = TRUE)
     
     ...

#Augment the original dataset   
pca_all_plot <- pca_fit |> 
  augment(MDR_df)
  
     ...
     
#Downsampling
min_n <- MDR_df |>
  count(Species) |> 
  summarise(min(n)) |> 
  pull()

balanced_df <- MDR_df |>
  group_by(Species) |>
  slice_sample(n = min_n) |>
  ungroup()
```
:::
::::::

## PCA {.smaller}

::::: columns
::: {.column width="50%"}
#### Before downsampling

![](images/08_PCA_all.png){style="\"width:100%"}
:::

::: {.column width="50%"}
#### After downsampling

![](images/08_PCA_downsampling.png){style="\"width:100%"}
:::
:::::

[After balancing species counts, the PCA shows largely shared resistance patterns across taxa, with only a few species, such as P. aeruginosa and S. marcescens, forming distinct clusters separate from the main E. coli-dominated continuum.]{style="font-size:0.7em; text-align:center; display:block;"}
