---
title: "03_augment"
format: html
---

## Load Libraries

```{r}
library(tidyverse)
library(here)
```

## Load Data

```{r}
mdr_data <- read.csv(here("data/cleaned_bacteria_data.csv"))
```

## Create New Table with Name and Class of Antibiotics

```{r}
antibiotic_table <- data.frame(
  Antibiotic = c(
    "AMX.AMP", "AMC", "CZ", "FOX", "CTX.CRO", "IPM",
    "GEN", "AN",
    "Acide.nalidixique", "ofx", "CIP",
    "C", "Co.trimoxazole", "Furanes", "colistine"
  ),
  Full_Name = c(
    "Amoxicillin / Ampicillin",
    "Amoxicillin + Clavulanic Acid",
    "Cefazolin",
    "Cefoxitin",
    "Cefotaxime / Ceftriaxone",
    "Imipenem",
    "Gentamicin",
    "Amikacin",
    "Nalidixic Acid",
    "Ofloxacin",
    "Ciprofloxacin",
    "Chloramphenicol",
    "Trimethoprim + Sulfamethoxazole",
    "Nitrofurantoin",
    "Colistin"
  ),
  Class = c(
    # β-lactams (Beta-lactams)
    "β-lactams (Beta-lactams)",
    "β-lactams (Beta-lactams)",
    "β-lactams (Beta-lactams)",
    "β-lactams (Beta-lactams)",
    "β-lactams (Beta-lactams)",
    "β-lactams (Beta-lactams)",

    # Aminoglycosides (Aminosides)
    "Aminoglycosides (Aminosides)",
    "Aminoglycosides (Aminosides)",

    # Quinolones / Fluoroquinolones
    "Quinolones / Fluoroquinolones",
    "Quinolones / Fluoroquinolones",
    "Quinolones / Fluoroquinolones",

    # Other Important Agents
    "Other Important Agents",
    "Other Important Agents",
    "Other Important Agents",
    "Other Important Agents"
  ),
  stringsAsFactors = FALSE
)

antibiotic_table
```

## Joining Antibiotic Table with MDR data

```{r}
Antibiotic = c(
    "AMX.AMP", "AMC", "CZ", "FOX", "CTX.CRO", "IPM",
    "GEN", "AN",
    "Acide.nalidixique", "ofx", "CIP",
    "C", "Co.trimoxazole", "Furanes", "colistine"
  )

# Pivot MDR Data to long form
mdr_long <- mdr_data |>
  pivot_longer(cols = all_of(Antibiotic),
               names_to = "Antibiotic",
               values_to = "Resistance")

# Join Antibiotics table to mdr_long 
mdr_joined <- mdr_long |> 
    left_join(antibiotic_table, by="Antibiotic")
```

```{r}
write.csv(mdr_joined, here("data/aug_long_bacteria_data.csv"), row.names = FALSE)
```

## MDR variable

To make linear model we will need a MDR variable, which assigns a numerical score to the resistance profile of each isolate. For every antibiotic tested, we added **1 point** if the isolate was classified as *Resistant (R)* and **0.5 points** if it was classified as *Intermediate (I)*, while *Susceptible (S)* contributed **0 points**. By summing these values across all antibiotics for each sample, we obtained a continuous MDR score that reflects the degree of multidrug resistance.

```{r}
count_resistance <- function(x) {
  case_when(
    x == "R" ~ 1,
    x == "I" ~ 0.5,
    x == "S" ~ 0
  )
}

antibiotics_cols <- colnames(mdr_data)[c(8:ncol(mdr_data))]


#Apply the case_when function to mutate every antibiotic column and sum into MDR variable
mdr_wide <- mdr_data |>
  mutate(
    across(antibiotics_cols, 
           count_resistance)) |> 
  mutate(MDR = rowSums(across(antibiotics_cols))) |> 
  drop_na(Age, Gender, Species, Diabetes, Hypertension, Hospital_before, Infection_Freq, MDR)   #Drop all NA in the columns used to model
```

We have to convert all categorical variables to factors so that the linear model can correctly treat them as categorical predictors and generate the appropriate variables for the analysis.

```{r}
mdr_wide <- mdr_wide |>
  mutate(
    Gender = factor(Gender),
    Species = factor(Species),
    Diabetes = factor(Diabetes),
    Hypertension = factor(Hypertension),
    Hospital_before = factor(Hospital_before),
    Infection_Freq = factor(Infection_Freq)
  )
```

This is a dataframe in wide format with the variable *MDR*, including the resistance pattern using sparse encoding and ready for linear modelling and PCA.

## Add Age Group Variable

```{r}
breaks <- seq(0, 90, 10)
labels <- paste0("[", head(breaks, -1), ",", tail(breaks, -1), "]")

mdr_wide <- mdr_wide |> 
  mutate(age_group = cut(
         x = Age,
         breaks = breaks,
             right = FALSE,
    include.lowest = TRUE,
    labels = labels))
```

```{r}
write.csv(mdr_wide, here("data/aug_wide_bacteria_data.csv"), row.names = FALSE)
```
