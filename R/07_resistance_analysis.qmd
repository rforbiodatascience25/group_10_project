---
title: "07_resistance_analysis"
author: "Edene Levine (s240875), Molly Hong-Minh (s242955), Pablo Fernandez (s243357), Vinit Nilesh Vasa (s242582)"
format: 
   html:
    embed-resources: true
editor: visual
---

## HeatMap

This analysis visualizes the resistance patterns of different bacterial species to various antibiotics using a heatmap. The raw dataset, which includes species, antibiotics, and resistance results (`R`, `S`, or `I`), was first transformed to create a binary `resistant` variable indicating whether a bacterium is resistant (`R`) or not. The data was then grouped by species and antibiotic to calculate the number of resistant and non-resistant cases, from which the frequency of resistance for each species-antibiotic pair was computed. The resulting heatmap uses a color gradient from blue (low resistance) through white (intermediate) to red (high resistance) to illustrate the proportion of resistant isolates, allowing for rapid identification of patterns in bacterial susceptibility. Additional analyses highlight which species exhibit the highest levels of resistance, sensitivity, or intermediate responses, providing insights into potential treatment challenges.

## Running Code

```{r}
library("tidyverse")
library("here")

data_long <- read.csv(here("data/aug_long_bacteria_data.csv"))

```

```{r}
#look at first few rows
head(data_long)
colnames(data_long)
```

### checking how many bacterias/species are there:

```{r}
data_long |>
  count(Species) 
```

### how many antibiotics

```{r}
data_long |>
  count(Antibiotic) 
```

### fixing the data

resistant - means if the results are R - e.g., True or False

and in the group_by- I calculate by each species by each antibiotic by each resistant. - how many true false are there in each group

then calculate the frequency

#### it is for each species!!!

```{r}
#calculating the frequency for all of the bacterias: result = R
resistant_data <- data_long |>
  mutate(resistant = Resistance == "R") |>
  group_by(Species, Antibiotic, resistant) |>
  summarise(n = n(), .groups = "drop_last") |>  # keep Species + Antibiotic grouping
  mutate(freq = n / sum(n))

resistant_data
```

saving the table:

```{r}
write.csv(resistant_data, here("data/resistant_data.csv"), row.names = FALSE)

```

### plotting the Heatmap

showing the Resistance of the bacteria to antibiotics.

it is calculate by each bacteria.

```{r}
heatmap_plot <- ggplot(resistant_data, aes(x = Antibiotic, y = Species, fill = freq)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0.50) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 90, hjust = 1, size = 15),
    axis.text.y = element_text(size = 15),
    axis.title = element_text(face = "bold", size = 17),
    plot.title = element_text(face = "bold", size = 20)
  ) +
  labs(title = "Resistance of the Bacteria to the Antibiotics", fill = "Frequency")

# Save the plot as PNG
ggsave("/net/pupil1/home/people/s240875/projects/group_10_project/results/images/heatmap_resistance.png", plot = heatmap_plot, width = 13, height = 10, dpi = 300)

heatmap_plot
```

R = Resistant: The bacteria does NOT respond to the antibiotic. The drug will likely not work.

S = Sensitive/Susceptible: The bacteria is killed by the antibiotic. The drug will work.

I = Intermediate: The bacteria is in-between, maybe the drug works at high dose, maybe not.

#### In the **Result column -** find how many S,R and I we have

```{r}
# Count overall R/S/I
data_long |>
  count(Resistance)
```

```{r}
# Count R/S/I per species
data_long |>
  count(Species, Resistance)
```

### which species has the most R

Escherichia coli

```{r}
data_long |>
  filter(Resistance == "R") |>
  group_by(Species) |>
  summarise(count_R = n()) |> 
  arrange(desc(count_R)) 
```

### which Species has the most S

Escherichia coli

```{r}
data_long |>
  filter(Resistance == "S") |>
  group_by(Species) |>
  summarise(count_S = n()) |> 
  arrange(desc(count_S)) 
```

### which Species has the most I

Escherichia coli

```{r}
data_long |>
  filter(Resistance == "I") |>
  group_by(Species) |>
  summarise(count_I = n()) |> 
  arrange(desc(count_I)) 
```

-   Frequency of infections per patient.

-   Encoded categories:

    -   `0` → Never

    -   `1` → Rarely

    -   `2` → Regularly

    -   `3` → Often

-   Includes anomalies such as `"unknown"`, `"error"`, `"missing"`.

    ### 
