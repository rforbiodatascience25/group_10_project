---
title: "04_description"
author: "Edene Levine (s240875), Molly Hong-Minh (s242955), Pablo Fernandez (s243357), Vinit Nilesh Vasa (s242582)"
format: 
   html:
    embed-resources: true
editor: visual
---

# Description of the Dataset

## Load Libraries

```{r}
#| warning: false
#| message: false

library(tidyverse)
library(here)
library(table1)
library(patchwork)
library(htmltools)
```

## Load Data

```{r}
mdr_data <- read.csv(here("data/cleaned_bacteria_data.csv"))
mdr_long <- read.csv(here("data/aug_long_bacteria_data.csv"))
mdr_wide <- read.csv(here("data/aug_wide_bacteria_data.csv"))
```

## Load Functions

```{r}
source(here("R/99_proj_func.R"))
```

## Data Inspection

```{r}
# Number of rows & columns
dim(mdr_data)
```

```{r}
mdr_data |> sample_n(10)
```

## Data Table

```{r}
# Table describing the data per species
t1 <- table1(
  ~ Age + Gender  + Diabetes + Hypertension + Hospital_before +
    Infection_Freq +
    AMX.AMP + AMC + CZ + FOX + CTX.CRO + IPM + GEN + AN +
    Acide.nalidixique + ofx + CIP + C + Co.trimoxazole +
    Furanes + colistine
  | Species,
  data = mdr_data
)

html_table <- as.tags(t1) 
save_html(html_table, file = here("results/images/table1.html"))


# Wrap table in div to shrink
html_table_resized <- tags$div(
  style = "overflow-x:auto; max-width:100%; zoom:0.7;",
  as.tags(t1)
)

# Save HTML to results/images in project
save_html(html_table_resized, file = here("results/images/table1_resized.html"))

```

## Table Describing Antibiotic Full Names & Class

```{r}
mdr_long |> 
  distinct(Antibiotic, Full_Name, Class)
```

## Visualisation of Variable Distributions

**Age and Gender**

```{r}
#| warning: false
 
p1  <- mdr_wide |> 
  ggplot(data = _, 
              aes(x = age_group, fill = Gender)) +
  geom_bar(stat = "count", color = "black") + 
  scale_y_continuous(breaks = seq(0, 2000, 250)) +
  labs( x = "Age", 
        y = "Count",
        title = "Age Distribution by Gender") +
  theme(plot.title = element_text(hjust = 0.5, size = 20),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 10),
        axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14))

save_png(
  plot     = p1,
  filename = here("results/images/04_Age_Gender.png")
)
```

**Species**

```{r}
#| warning: false

p2 <- mdr_data |> 
  ggplot(data = _, 
         aes(x = Species, fill = Species)) + 
  geom_bar(color = "black") +
    geom_text(stat = "count",
    aes(label = ..count..),
    vjust = -0.2,        # raise text above bars
    size = 2.8
  ) +
  scale_y_continuous(breaks = seq(0, 6000, 1000)) +
  labs( x = "Species", 
        y = "Count",
        title = "Species Distribution") +
  theme(plot.title = element_text(hjust = 0.5, size = 20),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 10),
        axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        legend.position = "none")

save_png(
  plot     = p2,
  filename = here("results/images/04_Species.png")
)
```

**Age Distribution per Species**

```{r}
p3 <- ggplot(mdr_data, aes(x = Species, y = Age, fill = Species)) +
  geom_boxplot(color = "black") +
  scale_y_continuous(breaks = seq(0, 90, 15)) +
  labs(title = "Age Distribution by Species",
       x = "Species",
       y = "Age") +
  theme(plot.title = element_text(hjust = 0.5, size = 20),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 10),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 14),
        legend.position = "none")

save_png(
  plot     = p3,
  filename = here("results/images/04_Age_Species.png")
)
```

**Hypertension, Diabetes, Hospital before, Infection Freq**

```{r}
#| warning: false
#| message: false

p4 <- plot_bar(mdr_data, Diabetes, "Diabetes")
p5 <- plot_bar(mdr_data, Hypertension, "Hypertension")
p6 <- plot_bar(mdr_data, Hospital_before, "Hospital Before")
p7 <- plot_bar(
        mdr_data |> mutate(Infection_Freq = factor(Infection_Freq, levels = c(0,1,2,3))),
        Infection_Freq,
        "Infection Freq"
      )

p8 <- (p4 + p5) / (p6 + p7)

save_png(
  plot     = p8,
  filename = here("results/images/04_Characteristics.png")
)
```

**Antibiotic Resistance Profiles**

```{r}
# Convert resistance to a factor 
mdr_long$Resistance <- factor(mdr_long$Resistance,
                              levels = c("S","I","R"))

p9 <- ggplot(mdr_long, aes(x = Antibiotic, fill = Resistance)) +
  geom_bar(position = "fill", color = "black") +
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Resistance Profile by Antibiotic",
    x = "Antibiotic",
    y = "Percent"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 18),
    axis.text.x = element_text(angle = 60, hjust = 1, size = 10),
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 14)
  )

save_png(
  plot     = p9,
  filename = here("results/images/04_Resistance_Profile.png")
)
```
